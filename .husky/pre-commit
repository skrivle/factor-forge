#!/usr/bin/env sh

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîç Checking for secrets before commit..."

# Patterns to detect
PATTERNS=(
  "npg_[a-zA-Z0-9]+"
  "sk-[a-zA-Z0-9]{20,}"
  "pk-[a-zA-Z0-9]{20,}"
  "AKIA[0-9A-Z]{16}"
  "-----BEGIN (RSA |DSA )?PRIVATE KEY-----"
  "mongodb://[^/]+:[^@]+@"
  "postgresql://[^/]+:[^@]+@"
  "mysql://[^/]+:[^@]+@"
)

# Check staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for file in $STAGED_FILES; do
  # Skip documentation and security-related files
  if [[ "$file" =~ \.(md|txt)$ ]] || [[ "$file" =~ scripts/(detect-secrets|clean-git-history|rotate-secrets)\.sh$ ]]; then
    continue
  fi
  
  if [ -f "$file" ]; then
    for pattern in "${PATTERNS[@]}"; do
      if grep -qE "$pattern" "$file" 2>/dev/null; then
        echo "${RED}‚ùå ERROR: Potential secret detected in $file${NC}"
        echo "${YELLOW}Pattern matched: $pattern${NC}"
        echo ""
        echo "If this is a false positive, you can:"
        echo "  1. Fix the file and try again"
        echo "  2. Use: git commit --no-verify (NOT recommended)"
        exit 1
      fi
    done
  fi
done

# Check for common secret file names
SECRET_FILES=(".env" ".env.local" ".env.production" "credentials.json" "secrets.yaml" "id_rsa" "private_key.pem")

for secret_file in "${SECRET_FILES[@]}"; do
  if echo "$STAGED_FILES" | grep -q "$secret_file"; then
    echo "${RED}‚ùå ERROR: Attempting to commit sensitive file: $secret_file${NC}"
    echo ""
    echo "This file should not be committed. Add it to .gitignore instead."
    exit 1
  fi
done

echo "‚úÖ No secrets detected"
